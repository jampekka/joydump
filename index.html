<!DOCTYPE html>
<html>
<body>
	<button id="download" onclick="download()">Download</button>
	<div id="controllers">
		
	</div>

<script src="FileSaver.js"></script>
<script src="jszip.js"></script>
<script>
function download() {
	console.log("download");
	//let jsonBlob = new Blob([JSON.stringify(log)], { type: 'application/javascript;charset=utf-8' });
	let output = new JSZip();
	let datestr = (new Date()).toISOString();
	let filebase = "joydump-" + datestr;
	output.file(filebase + ".json", JSON.stringify(log));
	output.generateAsync({type: "blob", compression: "DEFLATE"})
	.then((content) => {
		saveAs(content, filebase+".zip");
	});
}

function propdump(o) {
	if(typeof o !== "object") {
		return o;
	}
	let d = {};
	for(const prop in o) {
		d[prop] = propdump(o[prop]);
	}
	return d;
}

let controller_elements = {};
let prev_events = {};

let log = [];


function dump_joy(pad) {
	if(prev_events[pad.index] == pad.timestamp) {
		return;
	}
	prev_events[pad.index] = pad.timestamp;
	d = propdump(pad);
	d.unix_time = Date.now()/1000;
	//console.log(d);
	log.push(d);

	let el = controller_elements[pad.index];
	if(!el) {
		el = document.createElement("div");
		document.getElementById("controllers").append(el);
		controller_elements[pad.index] = el;
	}

	el.innerHTML = JSON.stringify(d);

}

function dump_joys() {
	for(let pad of navigator.getGamepads()) {
		dump_joy(pad);
	}
}

/*window.addEventListener(
	"gamepadconnected",
	(e) => {
		console.log("Here!");
		console.log(JSON.stringify(propdump(e.gamepad)));
	}
);*/
setInterval(dump_joys, 10);
</script>

</body>
</html>
